<html>
<head>

<title>The Battle for Zelda: Link's BLOODBATH</title>
<script src="/socket.io/socket.io.js"></script>
<script src="/static/jquery-1.7.1.min.js"></script>
<script src="/static/underscore.js"></script>
<script src="/static/class.js"></script>

<script src="/static/interpolate.js"></script>
<script src="/static/input-manager.js"></script>
<script src="/static/sprited-anim.js"></script>

<link rel="stylesheet" href="/static/index.css" />
<script>

var FPS = 35;
var INTERP = 100; // constant 100ms interpolation view delay

$(document).ready(function() {
	var canvas = $('#canvas')[0];
	var ctx = canvas.getContext('2d');
		  ctx.fillStyle='#ff0000';

	var players = {};
	var pid; 
	var socket = io.connect('http://localhost');

	socket.on('setPid', function (data) {
		pid = data.pid;
		console.log("Connected: " + data.pid)

		// handle user input
		players[pid] = new Hero();
		new InputManager(socket, pid, players[pid]);
	});

	// updates from backend
	var buf = new SnapshotBuffer();
	socket.on('update', function (data) {

		// store into the snapshot buffer
		buf.store(data);


		_.each(data.players, function(player, pid){
			if (players[pid] == undefined)
				players[pid] = new Hero();

			players[pid].setValue(player);
		});
	});
	
	// animation loop - perform INTERPOLATION to reduce jerkiness, buffer the snapshots
	setInterval(function() {
		ctx.clearRect(0,0, canvas.width, canvas.height);

		// interpolate using the last two snapshots -- do we need to use server timestamps or local ones? well we KNOW the snapshots are CREATED with consistent periods; 
		// go 100ms back in time; choose the snapshot 1 PRIOR and 1 AHEAD, interpolate between the two based on server timestamps
		var renderSnapshot = buf.getInterpolatedSnapshot();

		// foreach player, advance frame and draw
		_.each(players, function(player, pid){
		  player.draw(ctx);
	  });

	}, 1000 / FPS);







});
</script>
</head>
<body>

	<div id="main">

		<canvas width="500" height="500" id="canvas">

		</canvas>
	</div>
	<div id="interact">
	</div>

</body>


</html>